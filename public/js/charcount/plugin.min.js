/**
 * Created by Reinchard on 7/7/2017.
 */
tinymce.PluginManager.add('charactercount', function (editor) {
	var _self = this;

	function update() {
		editor.theme.panel.find('#charactercount').text(['Characters: {0}', _self.getCount()]);
	}

	function stop(e) {
		let allowedKeys = [8, 37, 38, 39, 40, 46];
		if (allowedKeys.indexOf(e.keyCode) != -1) return true;
		if (_self.getCount() >= 300) {
			e.preventDefault();
			e.stopPropagation();
			let content = editor.getContent();
			let cropedContent = content.substr(0, 300);
			editor.setContent(cropedContent);
			return false;
		}
		return true;
	}

	editor.on('init', function () {
		var statusbar = editor.theme.panel && editor.theme.panel.find('#statusbar')[0];
		if (statusbar) {
			window.setTimeout(function () {
				statusbar.insert({
					type: 'label',
					name: 'charactercount',
					text: ['Characters: {0}', _self.getCount()],
					classes: 'charactercount',
					disabled: editor.settings.readonly
				}, 0);

				editor.on('setcontent', function (e) {
					if (_self.getCount() > 300) {
						e.content = 'aloha';
					}
				});
				editor.on('setcontent beforeaddundo keyup', update);
			}, 0);
			editor.on('setcontent beforeaddundo keydown', stop);
		}
	});

	_self.getCount = function () {
		var tx = editor.getContent({format: 'raw'});
		var decoded = decodeHtml(tx);
		var decodedStripped = decoded.replace(/(<([^>]+)>)/ig, '');
		var tc = decodedStripped.length;
		return tc;
	};

	function decodeHtml(html) {
		var txt = document.createElement('textarea');
		txt.innerHTML = html;
		return txt.value;
	}
});
